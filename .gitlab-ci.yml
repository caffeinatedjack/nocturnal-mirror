stages:
  - test
  - build
  - release

variables:
  BINARY_NAME: nocturnal
  VERSION: ${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}
  BUILD_TIME: ${CI_PIPELINE_CREATED_AT}
  LDFLAGS: "-X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME}"

test:
  stage: test
  image: golang:1.23
  script:
    - go mod download
    - go test -v -race ./...

build:linux:
  stage: build
  image: golang:1.23
  needs:
    - test
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - GOOS=linux GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o ${BINARY_NAME}-linux-amd64 .
  artifacts:
    paths:
      - ${BINARY_NAME}-linux-amd64
    expire_in: 30 days

build:windows:
  stage: build
  image: golang:1.23
  needs:
    - test
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - GOOS=windows GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o ${BINARY_NAME}-windows-amd64.exe .
  artifacts:
    paths:
      - ${BINARY_NAME}-windows-amd64.exe
    expire_in: 30 days

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - build:linux
    - build:windows
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "Creating release for ${CI_COMMIT_TAG}"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: "Release $CI_COMMIT_TAG"
    assets:
      links:
        - name: "${BINARY_NAME}-linux-amd64"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/${BINARY_NAME}-linux-amd64"
        - name: "${BINARY_NAME}-windows-amd64.exe"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/${BINARY_NAME}-windows-amd64.exe"
