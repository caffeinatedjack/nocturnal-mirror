stages:
  - test
  - build
  - docker
  - release

variables:
  BINARY_NAME: nocturnal
  VERSION: ${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}
  BUILD_TIME: ${CI_PIPELINE_CREATED_AT}
  LDFLAGS: "-X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME}"
  # Set this to your container registry path if CI_REGISTRY_IMAGE is not auto-populated
  # Example: registry.gitlab.com/username/nocturnal
  CI_REGISTRY_IMAGE: ${CI_REGISTRY_IMAGE:-${CI_REGISTRY}/${CI_PROJECT_PATH}}

test:
  stage: test
  image: golang:1.23
  script:
    - go mod download
    - go test -v -race ./...

build:linux:
  stage: build
  image: golang:1.23
  needs:
    - test
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - GOOS=linux GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o ${BINARY_NAME}-linux-amd64 .
  artifacts:
    paths:
      - ${BINARY_NAME}-linux-amd64
    expire_in: 30 days

build:windows:
  stage: build
  image: golang:1.23
  needs:
    - test
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - GOOS=windows GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o ${BINARY_NAME}-windows-amd64.exe .
  artifacts:
    paths:
      - ${BINARY_NAME}-windows-amd64.exe
    expire_in: 30 days

build:macos:
  stage: build
  image: golang:1.23
  needs:
    - test
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - GOOS=darwin GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o ${BINARY_NAME}-darwin-amd64 .
    - GOOS=darwin GOARCH=arm64 go build -ldflags "${LDFLAGS}" -o ${BINARY_NAME}-darwin-arm64 .
  artifacts:
    paths:
      - ${BINARY_NAME}-darwin-amd64
      - ${BINARY_NAME}-darwin-arm64
    expire_in: 30 days

docker:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    IMAGE_TAG: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_SLUG}
    IMAGE_TAG_LATEST: ${CI_REGISTRY_IMAGE}:latest
  needs:
    - test
  rules:
    - if: $CI_COMMIT_TAG
  before_script:
    - echo "CI_REGISTRY=${CI_REGISTRY}"
    - echo "CI_REGISTRY_IMAGE=${CI_REGISTRY_IMAGE}"
    - echo "CI_COMMIT_REF_SLUG=${CI_COMMIT_REF_SLUG}"
    - echo "IMAGE_TAG=${IMAGE_TAG}"
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
  script:
    - |
      docker build \
        --build-arg VERSION=${VERSION} \
        --build-arg BUILD_TIME=${BUILD_TIME} \
        -t ${IMAGE_TAG} \
        -t ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA} \
        .
    - docker push ${IMAGE_TAG}
    - docker push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
    - docker tag ${IMAGE_TAG} ${IMAGE_TAG_LATEST}
    - docker push ${IMAGE_TAG_LATEST}

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - build:linux
    - build:windows
    - build:macos
    - docker
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "Creating release for ${CI_COMMIT_TAG}"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: "Release $CI_COMMIT_TAG"
    assets:
      links:
        - name: "${BINARY_NAME}-linux-amd64"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/${BINARY_NAME}-linux-amd64"
        - name: "${BINARY_NAME}-windows-amd64.exe"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/${BINARY_NAME}-windows-amd64.exe"
        - name: "${BINARY_NAME}-darwin-amd64"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/${BINARY_NAME}-darwin-amd64"
        - name: "${BINARY_NAME}-darwin-arm64"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/${BINARY_NAME}-darwin-arm64}"
        - name: "Docker Image"
          url: "${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}"
